name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install deps
        run: npm ci --ignore-scripts

      - name: Build JS
        run: npm run build

      - name: Bundle for pkg (CJS)
        run: |
          npx --yes esbuild@latest dist/index.js \
            --bundle \
            --platform=node \
            --format=cjs \
            --target=node20 \
            --outfile=dist/bundle.cjs

      - name: Package (pkg)
        run: |
          npx --yes @yao-pkg/pkg@latest \
            -t node20-linux-x64 \
            --output dist/omniboard-linux-x64 \
            dist/bundle.cjs
          
          cd dist
          tar -cvzf omniboard-linux-x64.tar.gz omniboard-linux-x64

      - name: Smoke test
        run: |
          ./dist/omniboard-linux-x64 --help

      - name: Prepare changelog
        run: npx ts-node ./tooling/release-changelog-extractor.ts

      - name: GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: CHANGELOG-latest.md
          files: dist/omniboard*.tar.gz
        env:
          GITHUB_REPOSITORY: omniboard-dev/analyzer